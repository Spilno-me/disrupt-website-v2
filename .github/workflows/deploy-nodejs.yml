name: "Deploy Disrupt Website (Node.js)"

on:
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'Skip tests during deployment'
        type: boolean
        default: false
      deploy_backend_only:
        description: 'Deploy only backend'
        type: boolean
        default: false
      deploy_frontend_only:
        description: 'Deploy only frontend'
        type: boolean
        default: false

env:
  NODE_VERSION: "22"
  SERVER_HOST: ${{ secrets.SERVER_HOST }}
  SERVER_USER: ${{ secrets.SERVER_USER }}
  FRONTEND_PATH: "/var/www/disruptinc.io/frontend"
  BACKEND_PATH: "/var/www/disruptinc.io/backend"
  LOGS_PATH: "/var/www/disruptinc.io/logs"

jobs:
  # ============================================
  # PREPARATION
  # ============================================
  prepare:
    name: "Prepare Deployment"
    runs-on: ubuntu-latest
    outputs:
      deploy_version: ${{ steps.version.outputs.version }}
      should_deploy_frontend: ${{ steps.changes.outputs.frontend }}
      should_deploy_backend: ${{ steps.changes.outputs.backend }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Generate deployment version
        id: version
        run: |
          VERSION=$(date +%Y%m%d_%H%M%S)_$(git rev-parse --short HEAD)
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Deployment version: ${VERSION}"

      - name: Detect changes
        id: changes
        run: |
          # Check if this is a manual trigger with specific deployment
          if [ "${{ inputs.deploy_backend_only }}" == "true" ]; then
            echo "frontend=false" >> $GITHUB_OUTPUT
            echo "backend=true" >> $GITHUB_OUTPUT
          elif [ "${{ inputs.deploy_frontend_only }}" == "true" ]; then
            echo "frontend=true" >> $GITHUB_OUTPUT
            echo "backend=false" >> $GITHUB_OUTPUT
          else
            # Auto-detect changes
            if git diff --name-only HEAD~1 HEAD | grep -q "^backend/"; then
              echo "backend=true" >> $GITHUB_OUTPUT
            else
              echo "backend=true" >> $GITHUB_OUTPUT  # Always deploy backend for now
            fi
            echo "frontend=true" >> $GITHUB_OUTPUT  # Always deploy frontend
          fi

  # ============================================
  # BUILD & TEST FRONTEND
  # ============================================
  build-frontend:
    name: "Build Frontend"
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_deploy_frontend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: npm ci
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Run tests
        if: ${{ !inputs.skip_tests }}
        run: npm test -- --run --reporter=verbose
        continue-on-error: true

      - name: Build frontend
        env:
          VITE_GA4_MEASUREMENT_ID: ${{ secrets.VITE_GA4_MEASUREMENT_ID }}
        run: npm run build

      - name: Upload frontend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: dist/
          retention-days: 7

  # ============================================
  # BUILD & TEST BACKEND
  # ============================================
  build-backend:
    name: "Build Backend"
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.should_deploy_backend == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: backend/package.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run backend tests
        if: ${{ !inputs.skip_tests }}
        working-directory: ./backend
        run: npm test
        continue-on-error: true

      - name: Validate Node.js syntax
        working-directory: ./backend
        run: |
          echo "Validating JavaScript/TypeScript files..."
          node --check server.js || echo "server.js not found, will be created"

      - name: Upload backend artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: |
            backend/
            !backend/node_modules/
          retention-days: 7

  # ============================================
  # DEPLOY TO SERVER
  # ============================================
  deploy:
    name: "Deploy to Production"
    runs-on: ubuntu-latest
    needs: [prepare, build-frontend, build-backend]
    if: |
      always() &&
      (needs.build-frontend.result == 'success' || needs.build-frontend.result == 'skipped') &&
      (needs.build-backend.result == 'success' || needs.build-backend.result == 'skipped')
    environment: production

    steps:
      - name: Download frontend artifacts
        if: needs.prepare.outputs.should_deploy_frontend == 'true'
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend-dist/

      - name: Download backend artifacts
        if: needs.prepare.outputs.should_deploy_backend == 'true'
        uses: actions/download-artifact@v4
        with:
          name: backend-build
          path: backend-dist/

      - name: Setup SSH key
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ env.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Create server directories
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            sudo mkdir -p ${{ env.FRONTEND_PATH }}
            sudo mkdir -p ${{ env.BACKEND_PATH }}
            sudo mkdir -p ${{ env.LOGS_PATH }}
            sudo chown -R ${{ env.SERVER_USER }}:${{ env.SERVER_USER }} /var/www/disruptinc.io
          "

      - name: Backup current deployment
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            BACKUP_DIR=/home/${{ env.SERVER_USER }}/backups
            mkdir -p \$BACKUP_DIR
            TIMESTAMP=\$(date +%Y%m%d_%H%M%S)

            if [ -d ${{ env.FRONTEND_PATH }} ] && [ \"\$(ls -A ${{ env.FRONTEND_PATH }})\" ]; then
              tar -czf \$BACKUP_DIR/frontend_\$TIMESTAMP.tar.gz -C ${{ env.FRONTEND_PATH }} . || true
            fi

            if [ -d ${{ env.BACKEND_PATH }} ] && [ \"\$(ls -A ${{ env.BACKEND_PATH }})\" ]; then
              tar -czf \$BACKUP_DIR/backend_\$TIMESTAMP.tar.gz -C ${{ env.BACKEND_PATH }} . || true
            fi

            # Keep only last 5 backups
            ls -t \$BACKUP_DIR/frontend_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm
            ls -t \$BACKUP_DIR/backend_*.tar.gz 2>/dev/null | tail -n +6 | xargs -r rm
          "

      - name: Deploy frontend
        if: needs.prepare.outputs.should_deploy_frontend == 'true'
        run: |
          echo "Deploying frontend..."

          # Clear old frontend files (except .htaccess if exists)
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            find ${{ env.FRONTEND_PATH }} -mindepth 1 -delete || true
          "

          # Upload new frontend files
          scp -r frontend-dist/* ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.FRONTEND_PATH }}/

          # Set permissions
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            sudo chown -R www-data:www-data ${{ env.FRONTEND_PATH }}
            sudo chmod -R 755 ${{ env.FRONTEND_PATH }}
          "

          echo "Frontend deployed successfully!"

      - name: Deploy backend
        if: needs.prepare.outputs.should_deploy_backend == 'true'
        run: |
          echo "Deploying backend..."

          # Upload backend files (excluding node_modules)
          scp -r backend-dist/* ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:${{ env.BACKEND_PATH }}/

          # Install dependencies and setup on server
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            cd ${{ env.BACKEND_PATH }}
            npm ci --production
          "

          echo "Backend files deployed successfully!"

      - name: Generate backend .env file
        if: needs.prepare.outputs.should_deploy_backend == 'true'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            cat > ${{ env.BACKEND_PATH }}/.env << 'ENVEOF'
          PORT=3001
          NODE_ENV=production
          SMTP_HOST=${{ secrets.SMTP_HOST }}
          SMTP_PORT=${{ secrets.SMTP_PORT }}
          SMTP_SECURE=${{ secrets.SMTP_SECURE }}
          SMTP_USER=${{ secrets.SMTP_USER }}
          SMTP_PASS=${{ secrets.SMTP_PASS }}
          TEAM_EMAIL=${{ secrets.TEAM_EMAIL }}
          FROM_EMAIL=${{ secrets.FROM_EMAIL }}
          FROM_NAME=${{ secrets.FROM_NAME }}
          ALLOWED_ORIGINS=https://disruptinc.io,https://www.disruptinc.io
          ENVEOF
            chmod 600 ${{ env.BACKEND_PATH }}/.env
          "

      - name: Restart backend with PM2
        if: needs.prepare.outputs.should_deploy_backend == 'true'
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            cd ${{ env.BACKEND_PATH }}

            # Check if PM2 process exists
            if pm2 describe disrupt-api > /dev/null 2>&1; then
              echo 'Restarting existing PM2 process...'
              pm2 restart disrupt-api
            else
              echo 'Starting new PM2 process...'
              pm2 start server.js --name disrupt-api \
                --log ${{ env.LOGS_PATH }}/app.log \
                --error ${{ env.LOGS_PATH }}/error.log \
                --time
            fi

            # Save PM2 process list
            pm2 save

            # Show status
            pm2 status
          "

      - name: Reload Nginx
        run: |
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "
            sudo nginx -t && sudo systemctl reload nginx
          "

  # ============================================
  # VERIFY DEPLOYMENT
  # ============================================
  verify:
    name: "Verify Deployment"
    runs-on: ubuntu-latest
    needs: [prepare, deploy]
    if: always() && needs.deploy.result == 'success'

    steps:
      - name: Wait for services to stabilize
        run: sleep 10

      - name: Health check - Frontend
        run: |
          echo "Checking frontend..."
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 30 https://disruptinc.io)
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "Frontend is accessible (HTTP $HTTP_STATUS)"
          else
            echo "Frontend check failed (HTTP $HTTP_STATUS)"
            exit 1
          fi

      - name: Health check - Backend API
        run: |
          echo "Checking backend API..."
          RESPONSE=$(curl -s --max-time 30 https://disruptinc.io/api/health)
          echo "API Response: $RESPONSE"

          if echo "$RESPONSE" | grep -q '"status":"OK"'; then
            echo "Backend API is healthy"
          else
            echo "Backend API health check failed"
            exit 1
          fi

      - name: Test contact form endpoint
        run: |
          echo "Testing contact form endpoint..."
          RESPONSE=$(curl -s -X POST https://disruptinc.io/api/send-email \
            -H "Content-Type: application/json" \
            -d '{"name":"GitHub Actions","email":"test@github.com","company":"GitHub","subject":"Deployment Test","message":"Automated deployment verification"}')
          echo "Contact form response: $RESPONSE"

      - name: Deployment summary
        run: |
          echo "=========================================="
          echo "        DEPLOYMENT SUCCESSFUL"
          echo "=========================================="
          echo "Version: ${{ needs.prepare.outputs.deploy_version }}"
          echo "Environment: Production"
          echo "Frontend: https://disruptinc.io"
          echo "API: https://disruptinc.io/api/"
          echo "=========================================="
